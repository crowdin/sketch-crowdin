<html>

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../bootstrap-select/dist/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="../styles.css">
    <script src="../popper.js/dist/umd/popper.min.js"></script>
    <script src="../jquery/dist/jquery.min.js"></script>
    <script src="../bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="../bootstrap-select/dist/js/bootstrap-select.min.js"></script>
</head>

<body>
    <div class="main-container">
        <nav class="navbar navbar-expand navbar-light plugin-tabs">
            <div class="container-fluid">
                <ul class="nav navbar-nav native-tabs">
                    <li class="nav-item" data-toggle="tooltip" data-placement="bottom"
                        crowdin-ui-text-details="stringsDetails">
                        <a crowdin-ui-text-label="stringsTab" id="strings-mode-nav" class="nav-link" href="#"
                            onclick="openModal('strings-mode');"></a>
                    </li>
                    <li class="nav-item" data-toggle="tooltip" data-id="settings" placement="bottom"
                        crowdin-ui-text-details="translationsDetails">
                        <a crowdin-ui-text-label="translationTab" id="translation-nav" class="nav-link" href="#"
                            onclick="openModal('translation');"></a>
                    </li>
                    <li class="nav-item">
                        <a crowdin-ui-text-label="settingsTab" id="settings-nav" class="nav-link" href="#"
                            onclick="openModal('settings');"></a>
                    </li>
                </ul>
                <ul class="nav navbar-nav navbar-right pr-2">
                    <a crowdin-ui-text-label="contactUsTab" class="link small" href="#" onclick="contactUsClick()"></a>
                </ul>
            </div>
        </nav>
        <main role="main">
            <div class="container" id="settings" style="display: none;">
                <form>
                    <fieldset class="mt-4">
                        <label crowdin-ui-text-label="connectionDetailsLabel" class="fieldset-label"></label>
                        <div class="form-group">
                            <label crowdin-ui-text-label="tokenLabel"></label>
                            <input type="password" class="form-control" id="token"
                                onchange="$('#connect-btn').attr('disabled', false);">
                            <p crowdin-ui-text-label="tokenDetailsText" class="form-text text-muted help-text mb-3">
                            </p>
                        </div>
                        <div class="form-group">
                            <label crowdin-ui-text-label="organizationLabel"></label>
                            <input type="text" class="form-control" id="organization"
                                onchange="$('#connect-btn').attr('disabled', false);">
                            <p crowdin-ui-text-label="organizationDetailsText" class="form-text text-muted help-text">
                            </p>
                            <button id="connect-btn" crowdin-ui-text-label="connectToCrowdinButton" type="button"
                                class="btn btn-primary btn-sm" onclick="saveCredentials()"></button>
                            <button id="logout-btn" crowdin-ui-text-label="logoutButton" type="button"
                                class="btn btn-secondary btn-sm float-right" onclick="logout()"></button>
                        </div>
                    </fieldset>
                    <fieldset class="mt-4">
                        <label crowdin-ui-text-label="projectConfigurationLabel" class="fieldset-label"></label>
                        <div class="form-group inline-select d-flex flex-row">
                            <label crowdin-ui-text-label="selectProjectLabel"></label>
                            <div class="inline-select-holder ml-2">
                                <select id="projects" onchange="onUpdateProject()"></select>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="inline-select d-flex flex-row">
                                <label>
                                    <abbr crowdin-ui-text-label="selectBranchLabel" crowdin-ui-text-details="branchDetails"></abbr>
                                </label>
                                <div class="inline-select-holder ml-2">
                                    <select id="branches" onchange="saveBranch().then(adjustToProjectType).then(clearStorage)"></select>
                                </div>
                            </div>
                        </div>
                        <p id="select-branch-error" crowdin-ui-text-label="selectBranchError"
                           class="form-text help-text text-error" style="display: none;">
                        </p>
                    </fieldset>
                    <fieldset class="mt-4">
                        <label crowdin-ui-text-label="advancedSettingsLabel" class="fieldset-label"></label>
                        <div class="adv-settings-container">
                            <div class="form-group mb-3">
                                <div>
                                    <label crowdin-ui-text-label="overrideTranslationsLabel" class="mb-0">
                                    </label>
                                    <input type="checkbox" class="ml-1 mt-1" id="overrideTranslations"
                                        onchange="saveOverrideTranslations()">
                                </div>
                                <p crowdin-ui-text-label="overrideTranslationsText"
                                    class="form-text text-muted help-text">
                                </p>
                            </div>
                            <div id="content-segmentation-block" class="form-group mb-3">
                                <div>
                                    <label crowdin-ui-text-label="contentSegmentationLabel" class="mb-0">
                                    </label>
                                    <input type="checkbox" class="ml-1 mt-1" id="contentSegmentation"
                                        onchange="saveContentSegmentation()">
                                </div>
                                <p crowdin-ui-text-label="contentSegmentationText"
                                    class="form-text text-muted help-text">
                                </p>
                            </div>
                            <div class="form-group">
                                <div class="inline-select d-flex flex-row">
                                    <label crowdin-ui-text-label="stringsKeyNamingLabel"></label>
                                    <div class="inline-select-holder ml-2">
                                        <select id="stringsKeyNaming" onchange="saveKeyNamingOption()">
                                        </select>
                                    </div>
                                </div>
                                <p crowdin-ui-text-label="stringsKeyNamingText" class="form-text text-muted help-text">
                                </p>
                            </div>
                            <div class="form-group" style="position: relative">
                                <label crowdin-ui-text-label="customKeyNamingPattern"></label>
                                <input type="text" class="form-control" id="customKeyNamingPattern"
                                    onchange="saveCustomKeyNaming()" oninput="handleHelperList()" disabled placeholder="e.g. [%Artboard].[%group].[%element_name]">
                                <div id="custom-naming-helper-list" class="custom-naming-helper-list">
                                </div>
                                <p crowdin-ui-text-label="stringsKeyNamingText" class="form-text text-muted help-text">
                                </p>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>

            <div class="container" id="strings-mode" style="display: none;">
                <form>
                    <div class="form-group list-strings-holder mb-4" id="list-strings">
                        <div class="row">
                            <div class="col-8">
                                <div class="search-wrapper">
                                    <input type="search" id="search-text" class="w-100" oninput="debounceSearch()"
                                        placeholder="Search">
                                </div>
                            </div>
                            <div class="col-1 strings-toolbar-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"
                                    fill="currentColor" class="float-right" onclick="reloadStrings();">
                                    <title crowdin-ui-text-label="stringsReloadButtonLabel"></title>
                                    <path fill-rule="evenodd"
                                        d="m8,1.5a6.491,6.491 0 0 0 -5.285,2.715l1.358,1.358a0.25,0.25 0 0 1 -0.177,0.427l-3.646,0a0.25,0.25 0 0 1 -0.25,-0.25l0,-3.646a0.25,0.25 0 0 1 0.427,-0.177l1.216,1.216a8,8 0 0 1 14.315,4.03a0.748,0.748 0 0 1 -0.668,0.83a0.75,0.75 0 0 1 -0.824,-0.676a6.501,6.501 0 0 0 -6.466,-5.827zm-7.288,6.504a0.75,0.75 0 0 1 0.822,0.67a6.501,6.501 0 0 0 11.751,3.111l-1.358,-1.358a0.25,0.25 0 0 1 0.177,-0.427l3.646,0a0.25,0.25 0 0 1 0.25,0.25l0,3.646a0.25,0.25 0 0 1 -0.427,0.177l-1.216,-1.216a8,8 0 0 1 -14.315,-4.03a0.75,0.75 0 0 1 0.67,-0.823z">
                                    </path>
                                </svg>
                            </div>
                            <div class="col-1">
                                <svg width="32" height="32" viewBox="0 0 32 32" fill="none"
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="string-upload-screenshots-icon float-right" onclick="uploadScreenshots()">
                                    <title crowdin-ui-text-label="uploadScreenshotsDetailsText"></title>
                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                        d="m16.26054,5.66424l-0.42299,0.39309l-2.69156,2.50169l0.84587,0.78618l1.67056,-1.55267l0,6.57972l1.19625,0l0,-6.57972l1.67044,1.55267l0.84587,-0.78618l-2.69156,-2.50169l-0.42287,-0.39309z"
                                        fill="currentColor" />
                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                        d="m11.97754,11.55025l-2.47164,0l0,7.83379l3.01306,-2.71189l0.43699,-0.39331l0.43686,0.39331l7.90333,7.11336l1.80381,0l0,-12.23526l-2.47164,0l0,-1.1123l2.47164,0c0.68254,0 1.23582,0.49798 1.23582,1.1123l0,12.23526c0,0.61432 -0.55328,1.1123 -1.23582,1.1123l-13.59405,0c-0.68252,0 -1.23582,-0.49798 -1.23582,-1.1123l0,-12.23526c0,-0.61432 0.5533,-1.1123 1.23582,-1.1123l2.47164,0l0,1.1123zm-2.47164,12.23526l0,-2.82846l3.45005,-3.1052l6.59249,5.93366l-10.04254,0z"
                                        fill="currentColor" />
                                </svg>
                            </div>
                            <div class="col-1 strings-toolbar-icon">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" onclick="openAddString()"
                                    xmlns="http://www.w3.org/2000/svg" class="float-right">
                                    <title crowdin-ui-text-label="addStringButton"></title>
                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                        d="m7.51819,1.534l0,13.13022l1.57233,0l0,-13.13022l-1.57233,0z"
                                        fill="currentColor" />
                                    <path fill-rule="evenodd" clip-rule="evenodd" transform="rotate(90 8.30435 8.09911)"
                                        d="m7.51819,1.534l0,13.13022l1.57233,0l0,-13.13022l-1.57233,0z"
                                        fill="currentColor" />
                                </svg>
                            </div>
                            <div class="col-1 strings-toolbar-icon">
                                <svg xmlns="http: //www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"
                                    class="float-right info-icon" fill="currentColor">
                                    <title crowdin-ui-text-label="useStringDetailsText"></title>
                                    <path fill-rule="evenodd"
                                        d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z">
                                    </path>
                                </svg>
                            </div>
                        </div>

                        <div id="strings-container" class="strings-container mt-3 bordered">
                        </div>
                    </div>
                    <fieldset id="edit-string" class="edit-string-mode" style="display: none;">
                        <div id="single-string-form">
                            <div id="edit-string-form-identifier" style="display: none;" class="form-group">
                                <label><abbr crowdin-ui-text-details="addStringIdentifierDetails"
                                        crowdin-ui-text-label="addStringIdentifierLabel"></abbr></label>
                                <input class="form-control" placeholder="identifier" id="edit-string-identifier" type="text">
                            </div>
                            <div class="form-group">
                                <label><abbr crowdin-ui-text-label="addStringStringLabel"
                                        crowdin-ui-text-details="addStringStringDetails"></abbr></label>
                                <label id="string-length-text" class="float-right" style="display: none;"></label>
                                <textarea class="form-control" id="string-text" placeholder="text"
                                    oninput="onStringTextInput()"></textarea>
                                <div class="invalid-feedback" id="invalidString"></div>
                            </div>
                            <div class="form-group" id="edit-string-form-identifier-new">
                                <label><abbr crowdin-ui-text-details="addStringIdentifierDetails"
                                        crowdin-ui-text-label="addStringIdentifierLabel"></abbr></label>
                                <input class="form-control" id="string-identifier" placeholder="identifier" type="text">
                                <div class="invalid-feedback" id="invalidIdentifier"></div>
                            </div>
                            <div class="form-group row">
                                <label class="col-8 col-form-label" for="string-max-length"><abbr
                                        crowdin-ui-text-label="addStringMaxLengthLabel"
                                        crowdin-ui-text-details="addStringMaxLengthDetails"></abbr></label>
                                <div class="col-4">
                                    <input min="0" type="number" class="form-control" id="string-max-length">
                                    <div class="invalid-feedback" id="invalidMaxLength"></div>
                                </div>
                            </div>
                            <div class="form-group" id="edit-string-form" style="display: none;">
                                <label><abbr crowdin-ui-text-details="addStringContextDetails"
                                        crowdin-ui-text-label="addStringContextLabel"></abbr></label>
                                <input class="form-control" id="string-context" placeholder="context" type="text">
                                <div class="invalid-feedback" id="invalidContext"></div>
                                <div>
                                    <label crowdin-ui-text-label="addStringUpdateScreenshotsLabel" class="mt-3 mb-3">
                                    </label>
                                    <input type="checkbox" class="ml-1" id="string-update-screenshot">
                                </div>
                            </div>
                        </div>
                        <div id="multi-string-form" class="multi-add-string-form-container" style="display: none;">
                            <div class="multi-strings-form__header row">
                                <label crowdin-ui-text-label="addStringStringLabel" class="col"></label>
                                <label crowdin-ui-text-label="addStringIdentifierLabel" class="col"></label>
                            </div>
                            <div class="strings-holder"></div>
                        </div>
                        <div id="string-file-container" class="form-group mt-2" style="display: none;">
                            <label for="string-files"><abbr crowdin-ui-text-label="addStringFileLabel"
                                    crowdin-ui-text-details="addStringFileDetails"></abbr></label>
                            <select class="form-control" id="string-files" multiple size="8"></select>
                            <div class="invalid-feedback" id="invalidFile"></div>
                        </div>
                        <div id="string-label-container" class="form-group mt-2">
                            <label for="string-labels"><abbr crowdin-ui-text-label="addStringLabelLabel"
                                    crowdin-ui-text-details="addStringLabelDetails"></abbr></label>
                            <select class="form-control" id="string-labels" multiple size="8"></select>
                        </div>
                        <div id="string-send-screenshots-container" class="form-group mb-1">
                            <label crowdin-ui-text-label="addStringSendScreenshotsLabel"></label>
                            <input type="checkbox" class="ml-1 mt-1" id="sendScreenshotsStrings" checked>
                        </div>
                        <div id="string-push-hidden-container" class="form-group mb-1">
                            <label crowdin-ui-text-label="addStringAddHiddenLabel"></label>
                            <input type="checkbox" class="ml-1 mt-1" id="pushHiddenStrings" checked>
                        </div>
                        <div id="string-link-duplicate-container" class="form-group mb-1">
                            <label crowdin-ui-text-label="addStringLinkDuplicateLabel"></label>
                            <input type="checkbox" class="ml-1 mt-1" id="linkDuplicateStrings" checked>
                        </div>
                        <div class="button-holder d-flex flex-row">
                            <button crowdin-ui-text-label="addStringSaveButtonLabel" type="button"
                                class="btn btn-primary btn-sm" onclick="saveString();"></button>
                            <button crowdin-ui-text-label="addStringCancelButtonLabel" type="button"
                                class="btn btn-secondary btn-sm ml-2" onclick="cancelEditString();"></button>
                            <button id="string-delete-btn" crowdin-ui-text-label="addStringDeleteButtonLabel"
                                type="button" class="btn btn-secondary btn-sm ml-auto"
                                onclick="deleteString();"></button>
                        </div>
                    </fieldset>
                    <div id="strings-preview">
                        <fieldset>
                            <!--neeeded to create space between fieldset borders-->
                            <label class="fieldset-select-space">&nbsp;</label>
                            <select id="preview-mode-option" class="fieldset-select" onchange="onPreviewModeChange();">
                                <option value="duplicate" crowdin-ui-text-label="previewStringsInDuplicateLabel">
                                </option>
                                <option value="current" crowdin-ui-text-label="previewStringsInCurrentLabel"></option>
                            </select>
                            <div class="form-group">
                                <p crowdin-ui-text-label="previewStringsDetailsText" class="form-text"></p>
                                <div id="preview-in-current-mode" class="form-row" style="display: none;">
                                    <div class="col-6 inline-select-holder">
                                        <select id="languages-preview-current" class="ml-1"></select>
                                    </div>
                                    <div class="col-3">
                                        <button crowdin-ui-text-label="previewAllButtonLabel" type="button"
                                            class="btn btn-secondary btn-sm btn-block"
                                            onclick="stringsPreview(true)"></button>
                                    </div>
                                    <div class="col-3">
                                        <button crowdin-ui-text-label="previewSelectedButtonLabel" type="button"
                                            class="btn btn-secondary btn-sm btn-block"
                                            onclick="stringsPreview(false)"></button>
                                    </div>
                                </div>
                                <div id="preview-in-duplicate-mode">
                                    <div class="form-row">
                                        <div class="col-6">
                                            <input onclick="onPreviewModeSubOptionChange(true);" type="radio"
                                                id="preview-mode-with-language" name="preview-mode-sub-option"
                                                value="true" checked />
                                            <label crowdin-ui-text-label="previewStringsWithLanguageLabel"></label>
                                        </div>
                                        <div class="col-6 inline-select-holder">
                                            <select id="languages-preview-duplicate" class="ml-1 mt-1"></select>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="col-6">
                                            <input onclick="onPreviewModeSubOptionChange(false);" type="radio"
                                                id="preview-mode-with-keys" name="preview-mode-sub-option"
                                                value="false" />
                                            <label crowdin-ui-text-label="previewStringsWithKeysLabel"></label>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="col-6">
                                            <button crowdin-ui-text-label="previewAllButtonLabel" type="button"
                                                class="btn btn-secondary btn-sm btn-block"
                                                onclick="stringsPreview(true)"></button>
                                        </div>
                                        <div class="col-6">
                                            <button id="string-preview-artboard-btn"
                                                crowdin-ui-text-label="previewSelectedButtonLabel" type="button"
                                                class="btn btn-secondary btn-sm btn-block"
                                                onclick="stringsPreview(false)"></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                </form>
            </div>

            <div class="container" id="translation" style="display: none;">
                <form>
                    <div id="translation-view">
                        <p class="form-text text-muted help-text" crowdin-ui-text-label="pagesDescription"></p>
                        <fieldset>
                            <label crowdin-ui-text-label="sendTextsLabel" class="fieldset-label"></label>
                            <div class="form-group">
                                <label crowdin-ui-text-label="sendTextsForLabel"></label>
                                <div class="form-row">
                                    <div class="col">
                                        <button crowdin-ui-text-label="sendTextsForPageButtonLabel" type="button"
                                            class="btn btn-secondary btn-sm btn-block"
                                            onclick="sendStrings(true)"></button>
                                    </div>
                                    <div class="col">
                                        <button id="upload-artboard-btn"
                                            crowdin-ui-text-label="sendTextsForArtboardButtonLabel" type="button"
                                            class="btn btn-secondary btn-sm btn-block"
                                            onclick="sendStrings(false)"></button>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <fieldset>
                            <label crowdin-ui-text-label="getTranslationsLabel" class="fieldset-label"></label>
                            <div class="form-group inline-select d-flex flex-row">
                                <label crowdin-ui-text-label="getTranslationsLanguageLabel"></label>
                                <div class="inline-select-holder ml-2">
                                    <select id="languages"></select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label crowdin-ui-text-label="uploadTranslationsLabelFor"></label>
                                <div class="form-row">
                                    <div class="col">
                                        <button crowdin-ui-text-label="uploadTranslationsForPageButtonLabel"
                                            type="button" class="btn btn-secondary btn-sm btn-block"
                                            onclick="translateComponent(true)"></button>
                                    </div>
                                    <div class="col">
                                        <button id="translate-artboard-btn"
                                            crowdin-ui-text-label="uploadTranslationsForArtboardButtonLabel"
                                            type="button" class="btn btn-secondary btn-sm btn-block"
                                            onclick="translateComponent(false)"></button>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <fieldset>
                            <label crowdin-ui-text-label="pseudoLocalizationLabel" class="fieldset-label"></label>
                            <label class="fieldset-label"><abbr crowdin-ui-text-label="pseudoLocalizationLabel"
                                    crowdin-ui-text-details="pseudoLocalizationDetails"></abbr></label>
                            <div class="form-group">
                                <label crowdin-ui-text-label="pseudoLocalizationLabelFor"></label>
                                <div class="form-row">
                                    <div class="col">
                                        <button crowdin-ui-text-label="pseudoLocalizationForPageButtonLabel"
                                            type="button" class="btn btn-secondary btn-sm btn-block"
                                            onclick="openPseudoLocalization(true)"></button>
                                    </div>
                                    <div class="col">
                                        <button id="pseudo-localization-artboard-btn"
                                            crowdin-ui-text-label="pseudoLocalizationForArtboardButtonLabel"
                                            type="button" class="btn btn-secondary btn-sm btn-block"
                                            onclick="openPseudoLocalization(false)"></button>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    <fieldset id="pseudo-localization-form" class="pseudo-localization-form" style="display: none;">
                        <div class="form-group">
                            <div class="inline-select d-flex flex-row">
                                <label crowdin-ui-text-label="pseudoLocalizationPresetLabel"></label>
                                <div class="inline-select-holder ml-2">
                                    <select id="pseudo-localization-preset"
                                        onchange="onPseudoLocalizationPresetChange()">
                                        <option value="notChosen">Not chosen</option>
                                        <option value="french">Improvised French</option>
                                        <option value="cyrillic">Improvised Cyrillic</option>
                                        <option value="chinese">Improvised Chinese</option>
                                        <option value="arabic">Improvised Arabic</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label crowdin-ui-text-label="pseudoLocalizationLengthCorrectionLabel"></label>
                            <p crowdin-ui-text-label="pseudoLocalizationLengthCorrectionText"
                                class="form-text text-muted help-text">
                            </p>
                            <div class="form-row">
                                <input min="-50" max="100" step="1" class="pr-0 pl-0 col-10" type="range"
                                    id="pseudo-localization-length-correction"
                                    oninput="updateLengthCorrection(this.value);" />
                                <label id="pseudo-localization-length-correction-value" class="col-2 mt-1"></label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label crowdin-ui-text-label="pseudoLocalizationPrefixSuffixLabel"></label>
                            <p crowdin-ui-text-label="pseudoLocalizationPrefixSuffixText"
                                class="form-text text-muted help-text">
                            </p>
                            <div class="form-row">
                                <input type="text" class="form-control col-5" id="pseudo-localization-prefix"
                                    placeholder="Prefix" />
                                <div class="col-1"></div>
                                <input type="text" class="form-control col-5" id="pseudo-localization-suffix"
                                    placeholder="Suffix" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label crowdin-ui-text-label="pseudoLocalizationCharacterTransformationLabel"></label>
                            <p crowdin-ui-text-label="pseudoLocalizationCharacterTransformationText"
                                class="form-text text-muted help-text">
                            </p>
                            <select id="pseudo-localization-character-transformation"
                                onchange="onPseudoLocalizationCharacterTransformationChange()">
                                <option value="notChosen">Not chosen</option>
                                <option value="asian">Asian (A -> 诶)</option>
                                <option value="cyrillic">Cyrillic (A -> Я)</option>
                                <option value="european">European (A -> Å)</option>
                                <option value="arabic">Arabic (A -> ئ)</option>
                            </select>
                        </div>
                        <div class="button-holder d-flex flex-row">
                            <button crowdin-ui-text-label="pseudoLocalizationApplyButtonLabel" type="button"
                                class="btn btn-secondary btn-sm" onclick="pseudoLocalize();"></button>
                            <button crowdin-ui-text-label="pseudoLocalizationCancelButtonLabel" type="button"
                                class="btn btn-secondary btn-sm ml-2" onclick="cancelPseudoLocalization();"></button>
                        </div>
                    </fieldset>
                </form>
            </div>

            <div id="spinner" class="modal fade bd-example-modal-lg show" data-backdrop="static" data-keyboard="false"
                tabindex="-1" style="display: none;" aria-modal="true">
                <div class="modal-dialog modal-sm">
                    <div class="modal-content" style="width: 48px">
                        <div class="spinner-border" role="status">
                            <span crowdin-ui-text-label="loadingDialog" class="sr-only"></span>
                        </div>
                    </div>
                </div>
            </div>


        </main>
        <div class="push"></div>
    </div>
    <div class="footer" id="footer"></div>
    <div id="modalFade" class="modal-backdrop fade show" style="display: none;"></div>
</body>

<script>
    const editableFileTypes = [
        "csv",
        "resx",
        "json",
        "i18next_json",
        "android",
        "macosx",
        "strings",
        "properties",
        "xliff",
        "arb",
        "gettext",
        "yaml",
        "xlsx"
    ];

    const CUSTOM_KEY_NAMING_PATTERN  = "Custom key naming pattern";

    let openedModal;

    // <!--<editor-fold desc="Initialization">-->
    showLoading();
    getCredentials()
        .then(getOverrideTranslations)
        .then(getContentSegmentation)
        .then(getKeyNamingOptions)
        .then(getCustomKeyPatternValue)
        .then(getProjects)
        .then(getBranches)
        .finally(() => {
            if (projectsInfo && projectsInfo.projects && projectsInfo.projects.length > 0) {
                adjustToProjectType();

                if (isStringsBased()) {
                  if (selectedBranch !== -1) {
                    openModal('strings-mode');
                  } else {
                    openModal('settings');
                  }
                } else {
                  openModal('strings-mode');
                }
                hideLoading();
            } else {
                openModal('settings');
                hideLoading();
            }
        });

    setInterval(() => {
        window.postMessage('isArtboardSelected').then(e => {
            const disabled = !e[0].selected;
            const title = disabled ? validationMessages.artboardNotSelected : '';
            $('#string-preview-artboard-btn').attr('disabled', disabled);
            $('#string-preview-artboard-btn').attr('title', title);
            $('#translate-artboard-btn').attr('disabled', disabled);
            $('#translate-artboard-btn').attr('title', title);
            $('#pseudo-localization-artboard-btn').attr('disabled', disabled);
            $('#pseudo-localization-artboard-btn').attr('title', title);
            $('#upload-artboard-btn').attr('disabled', disabled);
            $('#upload-artboard-btn').attr('title', title);
        });
    }, 100);

    let validationMessages = {};
    let allLanguagesOption;
    let noBranchOption;

    let projectsInfo;
    let sourceLanguage;
    let selectedBranch;
    let languages;
    let strings;
    let files;
    let labels;
    let openedString;
    let selectedText = [];
    // <!--</editor-fold>-->

    // <!--<editor-fold desc="Basic functions">-->
    function clearStorage() {
        sourceLanguage = undefined;
        strings = undefined;
        languages = undefined;
        files = undefined;
        labels = undefined;
        openedString = undefined;
        selectedText.length = 0;
    }

    function openModal(modal) {
        if (
          openedModal === modal
          || (isStringsBased() && selectedBranch === -1 && modal === 'strings-mode')
        ) {
            return;
        }

        $(`#${openedModal}`).hide();
        $(`#${openedModal}-nav`).removeClass('active');
        $(`#${modal}`).show();
        $(`#${modal}-nav`).addClass('active');
        openedModal = modal;
        switch (modal) {
            case 'strings-mode':
                openStringsMode();
                cancelPseudoLocalization();
                break;
            case 'translation':
                cancelEditString();
                openTranslationsTab();
                break;
            case 'settings':
                cancelEditString();
                cancelPseudoLocalization();
                openSettingsTab();
                break;
        }
    }

    function openSettingsTab() {
        $('#custom-naming-helper-list').hide()
    }

    function contactUsClick() {
        window.postMessage('contactUs');
    }

    function textFormatsClick() {
        window.postMessage('fileFormats');
    }

    function openTranslationsTab() {
        if (!languages) {
            showLoading();
            return getLanguages()
                .finally(hideLoading);
        }
    }

    function openStringsMode() {
        if (!sourceLanguage || !strings || (!files && !isStringsBased()) || !languages || !labels) {
            showLoading();
            return getFiles()
                .then(getSourceLanguage)
                .then(getLabels)
                .then(getStrings)
                .then(getLanguages)
                .finally(hideLoading);
        }
    }

    function showLoading() {
        $('#spinner').show();
        $('#modalFade').show();
    }

    function hideLoading() {
        $('#spinner').hide();
        $('#modalFade').hide();
    }
    // <!--</editor-fold>-->

    // <!--<editor-fold desc="Strings Based projects">-->
    function isStringsBased() {
        return projectsInfo.selectedProjectType === 1;
    }

    function adjustToProjectType() {
        if (isStringsBased()) {
            stringsBasedProjectElementsVisibility();
        } else {
            filesBasedProjectElementsVisibility();
        }
    }

    function stringsBasedProjectElementsVisibility() {
        $('#translation-nav').hide();
        $('#select-branch-error').hide();
        $('#content-segmentation-block').hide();

        if (selectedBranch === -1) {
            $('#select-branch-error').show();
        }
    }

    function filesBasedProjectElementsVisibility() {
        $('#translation-nav').show();
        $('#select-branch-error').hide();
        $('#content-segmentation-block').show();
    }
    // <!--</editor-fold>-->

    // <!--<editor-fold desc="Settings">-->
    function getCredentials() {
        return window.postMessage('getCredentials').then(creds => {
            $('#organization').val(creds[0].organization);
            $('#token').val(creds[0].token);
            $('#connect-btn').attr('disabled', !!creds[0].token);
            $('#logout-btn').attr('disabled', !creds[0].token);
        });
    }

    function saveCredentials() {
        showLoading();
        const token = $('#token').val();
        const organization = $('#organization').val();
        $('#connect-btn').attr('disabled', true);
        $('#logout-btn').attr('disabled', false);
        return window.postMessage('saveCredentials', { token, organization })
            .then(getCredentials)
            .then(getProjects)
            .then(saveProject)
            .then(getBranches)
            .then(saveBranch)
            .then(adjustToProjectType)
            .then(clearStorage)
            .finally(hideLoading);
    }

    function logout() {
        window.postMessage('logout').then(() => location.reload());
    }

    function onUpdateProject() {
        showLoading();
        return saveProject()
            .then(getBranches)
            .then(saveBranch)
            .then(clearStorage)
            .finally(hideLoading);
    }

    function saveProject() {
        const projectId = $('#projects option:selected').val();
        const projectType = projectsInfo.projects.filter(p => p.id === Number(projectId))[0].type;

        projectsInfo.selectedProjectId = projectId;
        projectsInfo.selectedProjectType = projectType;

        adjustToProjectType();

        return window.postMessage('saveProject', projectId, projectType);
    }

    function saveBranch() {
        const branchId = Number($('#branches option:selected').val());
        selectedBranch = branchId;
        return window.postMessage('saveBranch', branchId);
    }

    function saveOverrideTranslations() {
        return window.postMessage('saveOverrideTranslations', $('#overrideTranslations').prop('checked'));
    }

    function saveContentSegmentation() {
        return window.postMessage('saveContentSegmentation', $('#contentSegmentation').prop('checked'));
    }

    function saveKeyNamingOption() {
        const text = $('#stringsKeyNaming option:selected').text();
        $('#customKeyNamingPattern').attr('disabled', text != CUSTOM_KEY_NAMING_PATTERN);
        const option = Number($('#stringsKeyNaming option:selected').val());
        return window.postMessage('saveKeyPatternOption', option);
    }

    function saveCustomKeyNaming() {
        const text = $('#customKeyNamingPattern').val();
        return window.postMessage('saveCustomKeyPatternOption', text);
    }

    function handleHelperList() {
        const text = $('#customKeyNamingPattern').val();
        window.postMessage("getSearchHelperList", text).then(renderCustomNamingHelpers);
    }

    function onClickToHelperText(el) {
        const customKeyInputValue = $('#customKeyNamingPattern').val();
        const lastIndex = customKeyInputValue.lastIndexOf("[%");
        const substring = customKeyInputValue.substring(0, lastIndex + 2) + `${$(el).text()}]`;
        $('#customKeyNamingPattern').val(substring);
        window.postMessage('saveCustomKeyPatternOption', substring);
        $('#custom-naming-helper-list').hide();

    }

    function renderCustomNamingHelpers (options) {
        if(!options[0].length) {
            $('#custom-naming-helper-list').hide()
            return
        }
        $("#custom-naming-helper-list").empty()
        $('#custom-naming-helper-list').show()
        options[0].forEach(el => {
            if(el) {
                const listItem = `<p onclick="onClickToHelperText(this)">${el}<p>`
                $('#custom-naming-helper-list').append(listItem);
            }
        })
    }
    // <!--</editor-fold>-->

    // <!--<editor-fold desc="Pages section">-->
    function translateComponent(wholePage) {
        showLoading();
        const languageId = $('#languages option:selected').val();
        return window.postMessage('translate', languageId, wholePage).finally(hideLoading);
    }

    function sendStrings(wholePage) {
        showLoading();
        return window.postMessage('sendStrings', wholePage).finally(hideLoading);
    }

    function openPseudoLocalization(wholePage) {
        $('#pseudo-localization-form').show();
        $('#pseudo-localization-form').attr('pseudo-localization-whole-page', wholePage);
        $('#translation-view').hide();
        $('#pseudo-localization-form').show();
    }

    function cancelPseudoLocalization() {
        $('#pseudo-localization-length-correction').val(0);
        updateLengthCorrection(0);
        $('#pseudo-localization-character-transformation').val('notChosen');
        $('#pseudo-localization-preset').val('notChosen');
        $('#pseudo-localization-prefix').val('');
        $('#pseudo-localization-suffix').val('');
        $('#translation-view').show();
        $('#pseudo-localization-form').hide();
    }

    function onPseudoLocalizationPresetChange() {
        const preset = $('#pseudo-localization-preset option:selected').val();
        let lengthCorrection = 0;
        let characterTransformation = 'notChosen';
        switch (preset) {
            case 'french':
                characterTransformation = 'european';
                break;
            case 'cyrillic':
                lengthCorrection = 25;
                characterTransformation = 'cyrillic';
                break;
            case 'chinese':
                lengthCorrection = -35;
                characterTransformation = 'asian';
                break;
            case 'arabic':
                lengthCorrection = -20;
                characterTransformation = 'arabic';
                break;
        }
        $('#pseudo-localization-length-correction').val(lengthCorrection);
        updateLengthCorrection(lengthCorrection);
        $('#pseudo-localization-character-transformation').val(characterTransformation);
    }

    function updateLengthCorrection(value) {
        $('#pseudo-localization-length-correction-value').text(`${value}%`);
    }

    function onPseudoLocalizationCharacterTransformationChange() {
        const preset = $('#pseudo-localization-preset option:selected').val();
        if (preset !== 'notChosen') {
            $('#pseudo-localization-length-correction').val(0);
            updateLengthCorrection(0);
            $('#pseudo-localization-character-transformation').val('notChosen');
            $('#pseudo-localization-preset').val('notChosen');
        }
    }

    function pseudoLocalize() {
        const wholePage = $('#pseudo-localization-form').attr('pseudo-localization-whole-page') === 'true';
        const lengthTransformation = Number($('#pseudo-localization-length-correction').val());
        let charTransformation = $('#pseudo-localization-character-transformation').val();
        charTransformation = charTransformation === 'notChosen' ? undefined : charTransformation;
        const prefix = $('#pseudo-localization-prefix').val();
        const suffix = $('#pseudo-localization-suffix').val();
        const request = { wholePage, lengthTransformation, charTransformation, prefix, suffix };
        showLoading();
        window.postMessage('pseudoLocalize', request)
            .then(cancelPseudoLocalization)
            .finally(hideLoading);
    }
    // <!--</editor-fold>-->

    // <!--<editor-fold desc="Strings section">-->
    function onPreviewModeChange() {
        const previewMode = $('#preview-mode-option option:selected').val();
        onPreviewModeSubOptionChange(true);
        $('#preview-mode-with-language').click();
        if (previewMode === 'duplicate') {
            $('#preview-in-current-mode').hide();
            $('#preview-in-duplicate-mode').show();
            $('#languages-preview-duplicate').val('-1');
        } else {
            $('#preview-in-duplicate-mode').hide();
            $('#preview-in-current-mode').show();
            $('#languages-preview-current').val(sourceLanguage ? sourceLanguage.id : '-1');
        }
    }

    function onPreviewModeSubOptionChange(value) {
        if (!value) {
            $('#languages-preview-duplicate').attr('disabled', 'true');
        } else {
            $('#languages-preview-duplicate').removeAttr('disabled');
        }
    }

    $('#string-files').on('changed.bs.select', onAddStringFileSelect);
 
    function onAddStringFileSelect() {
        const selectedFiles = $('#string-files option:selected').toArray().length;
        if (selectedFiles > 1) {
            $('#linkDuplicateStrings').attr('disabled', 'true');
        } else {
            $('#linkDuplicateStrings').removeAttr('disabled');
        }
    }

    function useString(e) {
        showLoading();
        const id = Number($(e).attr('int-id'));
        const identifier = $(e).attr('str-id');
        const text = $(e).text().trim();
        return window.postMessage('useString', [{ id, text, identifier }])
            .then(e => {
                if (!e[0].error) {
                    markAsUsed(id);
                    e[0].stringsToDeselect.forEach(markAsUnused);
                }
            })
            .finally(hideLoading);
    }

    function deselectString(e) {
        showLoading();
        const id = Number($(e).attr('int-id'));
        return window.postMessage('deselectString', id)
            .then(e => {
                if (!e[0].error) {
                    markAsUnused(id);
                }
            })
            .finally(hideLoading);
    }

    function uploadScreenshots() {
        showLoading();
        return window.postMessage('uploadScreenshots', undefined, false).finally(hideLoading);
    }

    function stringsPreview(wholePage) {
        showLoading();
        const previewMode = $('#preview-mode-option option:selected').val();
        let langId;
        let langName;
        let translations;
        if (previewMode === 'duplicate') {
            const suboption = $("input[name='preview-mode-sub-option']:checked").val();
            if (suboption === 'true') {
                langId = $('#languages-preview-duplicate option:selected').val();
                langName = $('#languages-preview-duplicate option:selected').text();
            } else {
                langId = 'keys';
                langName = 'keys';
                translations = (strings || []).map(s => {
                    return {
                        data: {
                            stringId: s.id,
                            text: s.identifier || `string ${s.id}`
                        }
                    };
                });
            }
        } else {
            langId = $('#languages-preview-current option:selected').val();
            langName = $('#languages-preview-current option:selected').text();
            if (sourceLanguage && langId === sourceLanguage.id) {
                translations = (strings || []).map(s => {
                    return {
                        data: {
                            stringId: s.id,
                            text: s.text
                        }
                    };
                });
            }
        }
        return window.postMessage('stringsPreview', { langId, langName, previewMode, translations }, wholePage).finally(hideLoading);
    }

    function reloadStrings() {
        strings = undefined;
        files = undefined;
        labels = undefined;
        showLoading();
        return getFiles()
            .then(getLabels)
            .then(getStrings)
            .finally(hideLoading);
    }
    // <!--</editor-fold>-->

    // <!--<editor-fold desc="Strings management">-->
    function openEditString(element) {
        $('#string-delete-btn').show();
        showLoading();
        window.postMessage('getUsedStrings')
            .then((e) => {
                const usedStrings = e[0];
                const el = $(element);
                $('#edit-string-form-identifier-new').hide();
                $('#list-strings').hide();
                $('#strings-preview').hide();
                $('#multi-string-form').hide();
                $('#string-file-container').hide();
                $('#string-label-container').hide();
                $('#string-push-hidden-container').hide();
                $('#string-send-screenshots-container').hide();
                $('#string-link-duplicate-container').hide();
                $('#edit-string-form').show();
                $('#string-length-text').show();
                $('#edit-string-form-identifier').show();
                $('#single-string-form').show();
                $('#edit-string').show();
                const id = Number(el.next().attr('int-id'));
                const isUsed = usedStrings.includes(id);
                const string = strings.find(str => str.id === id);
                if (isUsed) {
                    $('#string-update-screenshot').removeAttr('disabled');
                    $('#string-update-screenshot').removeAttr('title');
                    $('#string-update-screenshot').prop('checked', true);
                } else {
                    $('#string-update-screenshot').attr('disabled', 'true');
                    $('#string-update-screenshot').parent().attr('title', validationMessages.editStringNoLinks);
                    $('#string-update-screenshot').prop('checked', false);
                }
                $('#string-text').val(string.text);
                $('#edit-string-form-identifier').find('input').val(string.identifier || '');
                $('#string-context').val(string.context) || '';
                $('#string-max-length').val(string.maxLength);
                openedString = id;
                onStringTextInput();
                hideLoading();
            });
    }

    function openAddString() {
        $('#string-delete-btn').hide();
        showLoading();
        window.postMessage('getSelectedText').then((e) => {
            selectedText = e[0];

            $('#list-strings').hide();
            $('#strings-preview').hide();
            $('#string-push-hidden-container').hide();

            if (!isStringsBased()) {
              $('#string-file-container').show();
            }

            $('#string-label-container').show();
            $('#string-link-duplicate-container').show();
            $('#edit-string').show();

            if (selectedText.length === 0) {
                //no text selected just a new Crowdin string
                $('#string-link-duplicate-container').hide();
                $('#sendScreenshotsStrings').attr('disabled', 'true');
                $('#sendScreenshotsStrings').prop('checked', false);
                $('#string-text').val('');
                $('#string-identifier').val('');
                $('#string-max-length').val('');
                $('#multi-string-form').hide();
                $('#single-string-form').show();
            } else if (selectedText.length === 1) {
                //one text selected
                $('#sendScreenshotsStrings').removeAttr('disabled');
                $('#sendScreenshotsStrings').prop('checked', true);
                $('#linkDuplicateStrings').removeAttr('disabled');
                $('#linkDuplicateStrings').prop('checked', false);
                onAddStringFileSelect();
                $('#string-text').val(selectedText[0].text);
                $('#string-identifier').val(generateIdentifier(selectedText[0], (strings || []).map(s => s.identifier)));
                $('#string-max-length').val('');
                $('#multi-string-form').hide();
                $('#single-string-form').show();
                $('#string-send-screenshots-container').show();
            } else {
                //multiple texts selected
                $('#sendScreenshotsStrings').removeAttr('disabled');
                $('#sendScreenshotsStrings').prop('checked', true);
                $('#linkDuplicateStrings').removeAttr('disabled');
                $('#linkDuplicateStrings').prop('checked', false);
                onAddStringFileSelect();
                let rowsHtml = '';
                let identifiers = (strings || []).map(s => s.identifier);
                selectedText.forEach(e => {
                    const identifier = generateIdentifier(e, identifiers);
                    identifiers.push(identifier);
                    rowsHtml += `
                    <div class="form-row" id="mass-adding-string-${identifier}">
                        <div class="col-6">
                            <textarea class="form-control" placeholder="text">${e.text}</textarea>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-5 max-width-40">
                            <input type="text" class="form-control" placeholder="identifier" value="${identifier}">
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-1">
                            <svg onclick="removeStringFromForm('${identifier}')" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="string-row-delete">
                                <g>
                                <rect transform="rotate(45 7.74139 8.43104)" height="1" width="10" y="7.93104" x="2.74139" stroke="null"  fill="currentColor"/>
                                <rect transform="rotate(-45 7.82759 8.17242)" height="1" width="10" y="7.67242" x="2.82759" stroke="null" fill="currentColor"/>
                                </g>
                            </svg>
                        </div>
                    </div>
                    `;
                });
                const html = `<div class="form-group">${rowsHtml}</div>`;
                $('#multi-string-form .strings-holder').empty();
                $('#multi-string-form .strings-holder').append(html);
                $('#single-string-form').hide();
                $('#multi-string-form').show();
                $('#string-push-hidden-container').show();
                $('#string-send-screenshots-container').show();
            }
            openedString = undefined;
            hideLoading();
        });
    }

    function generateIdentifier(selectedTextElement, identifiers) {
        const pattern = $('#stringsKeyNaming option:selected').text();
        const customKeyPattern = $('#customKeyNamingPattern').val();
        const artboardName = selectedTextElement.artboard.toLowerCase();
        const groupName = selectedTextElement.group.toLowerCase();
        const elementName = selectedTextElement.elementName.toLowerCase();
        const artboardNameUpperCase = capitalizeFirstLetter(artboardName);
        const groupNameUpperCase = capitalizeFirstLetter(groupName);
        const elementNameUpperCase = capitalizeFirstLetter(elementName);
        const identifier = smartReplace(pattern, customKeyPattern, {
            'Artboard': artboardNameUpperCase,
            'artboard': artboardName,
            'Group': groupNameUpperCase,
            'group': groupName,
            'Element_name': elementNameUpperCase,
            'element_name': elementName,
            'Element text': selectedTextElement.text
        });
        let uniqueIdentifier = identifier;
        //make unique
        let increment;
        for (; ;) {
            if (identifiers.some(i => i === uniqueIdentifier)) {
                increment = !!increment ? (increment + 1) : 1;
                uniqueIdentifier = identifier + increment;
            } else {
                break;
            }
        }
        return uniqueIdentifier;
    }

    function smartReplace(pattern, customPattern, obj) {
        if (pattern === CUSTOM_KEY_NAMING_PATTERN) {
            const patterns = Object.keys(obj);
            patterns.forEach((el) => {
                if (customPattern.indexOf(`[%${el}]`) !== -1) {
                    customPattern = customPattern.replaceAll(`[%${el}]`, obj[el]);
                }
            });
            return customPattern;
        }
        const replacing = {};
        for (let x in obj) {
            if (pattern.indexOf(x) > -1) {
                replacing[pattern.indexOf(x)] = {
                    to: x.length + pattern.indexOf(x),
                    by: obj[x]
                };
            }
        }
        let result = '';
        for (let i = 0; i < pattern.length; i++) {
            let replaced = false;
            for (let replacingIndex in replacing) {
                if (Number(replacingIndex) === i) {
                    replaced = true;
                    i = replacing[replacingIndex].to - 1;
                    result += replacing[replacingIndex].by;
                }
            }
            if (!replaced) {
                result += pattern.charAt(i);
            }
        }
        return result;
    };

    function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }

    function cancelEditString() {
        $('#edit-string-form-identifier-new').show();
        $('#list-strings').show();
        $('#strings-preview').show();
        $('#edit-string').hide();
        $('#invalidString').text('');
        $('#invalidIdentifier').text('');
        $('#invalidMaxLength').text('');
        $('#invalidContext').text('');
        $('#invalidFile').text('');
        $('#string-labels').selectpicker('deselectAll');
        $('#edit-string-form').hide();
        $('#string-length-text').hide();
        $('#edit-string-form-identifier').hide();
        selectedText.length = 0;
    }

    function onStringTextInput() {
        const length = ($('#string-text').val() || '').length;
        $('#string-length-text').text(`${length} character${length > 1 ? 's' : ''}`);
    }

    function deleteString() {
        if (openedString) {
            showLoading();
            window.postMessage('deleteString', { id: openedString })
                .then(e => {
                    if (!e[0].error) {
                        strings = strings.filter(e => e.id !== openedString);
                        cancelEditString();
                        return search();
                    }
                })
                .finally(hideLoading);
        } else {
            cancelEditString();
        }
    }

    function removeStringFromForm(identifier) {
        $(`[id="mass-adding-string-${identifier}"]`).hide();
        const rows = $('#multi-string-form div.form-group div.form-row');
        const removed = rows.toArray().filter(e => !$(e).is(':visible'));
        if (selectedText.length - 1 === removed.length) {
            $('#multi-string-form .strings-holder svg').hide();
        }
    }

    function saveString() {
        const identifiers = (strings || []).map(s => s.identifier);
        const sendScreenshots = $('#sendScreenshotsStrings').prop('checked');
        const linkDuplicated = $('#linkDuplicateStrings').prop('checked');

        if (selectedText.length > 1) {
            // adding multiple strings
            $('#multi-string-form div.form-group .invalid-feedback').text('');
            const pushHidden = $('#pushHiddenStrings').prop('checked');
            const files = $('#string-files option:selected').toArray();
            const labelIds = $('#string-labels option:selected').toArray().map(l => Number($(l).val()));
            const newStrings = [];
            const rows = $('#multi-string-form div.form-group div.form-row');
            for (let i = 0; i < rows.length; i++) {
                const row = $(rows[i]);
                if (!row.is(':visible')) {
                    continue;
                }
                const text = $(row.find('textarea')[0]).val();
                const identifier = $(row.find('input')[0]).val();
                if (!text || text.length === '') {
                    $(row.find('.invalid-feedback')[0]).text(validationMessages.addStringEmptyString || 'Invalid');
                    return;
                }
                if (!identifier || identifier.length === '') {
                    $(row.find('.invalid-feedback')[1]).text(validationMessages.addStringEmptyIdentifier || 'Invalid');
                    return;
                }
                if (identifiers.some(i => i === identifier)) {
                    $(row.find('.invalid-feedback')[1]).text(validationMessages.addStringNotUniqueIdentifier || 'Invalid');
                    return;
                }
                if (!pushHidden && selectedText[i].hidden) {
                    continue;
                }
                identifiers.push(identifier);
                newStrings.push({
                    text,
                    identifier,
                    selectedText: selectedText[i]
                });
            }
            showLoading();
            const addedStrings = [];
            // TODO: files
            const promises = files.map(file => {
                return newStrings.reduce((acc, str) => {
                    return acc.then(() => {
                        if (linkDuplicated) {
                            const existingString = strings.find(s => s.text === str.text);
                            if (existingString) {
                                addedStrings.push({
                                    id: existingString.id,
                                    identifier: existingString.identifier,
                                    selectedText: str.selectedText,
                                    text: existingString.text,
                                    existing: true
                                });
                                return;
                            }
                        }
                        return window
                            .postMessage('addString', {
                                text: str.text,
                                identifier: str.identifier,
                                fileId: Number($(file).val()),
                                labelIds: labelIds.length > 0 ? labelIds : undefined
                            })
                            .then(e => {
                                if (!e[0].error) {
                                    strings.push({
                                        id: e[0].data.id,
                                        text: str.text,
                                        fileId: Number($(file).val()),
                                        identifier: str.identifier,
                                        context: str.identifier,
                                        maxLength: 0,
                                        labelIds
                                    });
                                    addedStrings.push({
                                        id: e[0].data.id,
                                        existing: false,
                                        ...str
                                    });
                                }
                            })
                    });
                }, Promise.resolve());
            });
            return Promise.all(promises)
                .then(() => {
                    // TODO: files
                    const stringsToProcess = addedStrings.filter(newString => newString.existing || files.length === 1);
                    if (stringsToProcess.length > 0) {
                        return window
                            .postMessage('useString', stringsToProcess)
                            .then(() => {
                                if (sendScreenshots) {
                                    return window.postMessage('uploadScreenshots', stringsToProcess.map(e => e.id), true);
                                }
                            });
                    }
                })
                .then(() => {
                    cancelEditString();
                    return search();
                })
                .finally(hideLoading);
        }
        $('#invalidString').text('');
        $('#invalidIdentifier').text('');
        $('#invalidMaxLength').text('');
        $('#invalidContext').text('');
        $('#invalidFile').text('');
        const text = $('#string-text').val();
        const maxLength = Number($('#string-max-length').val());
        if (!text || text.length === '') {
            $('#invalidString').text(validationMessages.addStringEmptyString || 'Invalid');
            return;
        }
        if (!$('#string-max-length')[0].validity.valid) {
            $('#invalidMaxLength').text(validationMessages.addStringInvalidMaxLength || 'Invalid');
            return;
        }
        if (openedString) {
            const context = $('#string-context').val();
            const identifier = $('#edit-string-identifier').val();
            const updateScreenshots = $('#string-update-screenshot').prop('checked');
            if (!context || context.length === '') {
                $('#invalidContext').text(validationMessages.addStringEmptyContext || 'Invalid');
                return;
            }
            //editing string
            showLoading();
            return window
                .postMessage('editString', {
                    id: openedString,
                    text,
                    context,
                    maxLength,
                    identifier
                })
                .then(e => {
                    if (!e[0].error) {
                        strings = strings.map(s => {
                            if (s.id === openedString) {
                                s.text = text;
                                s.context = context;
                                s.maxLength = maxLength;
                                s.identifier = identifier;
                            }
                            return s;
                        });
                        const promise = updateScreenshots
                            ? window.postMessage('uploadScreenshots', [openedString], true)
                            : Promise.resolve();
                        return promise.finally(() => {
                            cancelEditString();
                            return search();
                        });
                    }
                })
                .finally(hideLoading);
        } else {
            //adding single string
            const identifier = $('#string-identifier').val();
            // TODO: files
            const files = $('#string-files option:selected').toArray();
            const labelIds = $('#string-labels option:selected').toArray().map(l => Number($(l).val()));
            if (!identifier || identifier.length === '') {
                $('#invalidIdentifier').text(validationMessages.addStringEmptyIdentifier || 'Invalid');
                return;
            }
            if (identifiers.some(i => i === identifier)) {
                $('#invalidIdentifier').text(validationMessages.addStringNotUniqueIdentifier || 'Invalid');
                return;
            }
            showLoading();
            if (linkDuplicated && selectedText.length > 0) {
                const existingString = strings.find(s => s.text === text);
                if (existingString) {
                    return window
                        .postMessage('useString', [{
                            id: existingString.id,
                            text,
                            identifier: existingString.identifier,
                            selectedText: selectedText[0]
                        }])
                        .then(() => {
                            if (sendScreenshots) {
                                return window.postMessage('uploadScreenshots', [existingString.id], true);
                            }
                        })
                        .then(() => {
                            cancelEditString();
                            return search();
                        })
                        .finally(hideLoading);

                }
            }

            // TODO: files
            const promises = files.map(file => {
                const req = {
                    text,
                    identifier,
                    maxLength: $('#string-max-length').val().length === 0 ? undefined : maxLength,
                    fileId: Number($(file).val()),
                    labelIds: labelIds.length > 0 ? labelIds : undefined
                };
                return window.postMessage('addString', req)
                    .then(e => {
                        if (!e[0].error) {
                            const id = e[0].data.id;
                            strings.push({
                                id,
                                text: text,
                                fileId: Number($(file).val()),
                                identifier: identifier,
                                context: identifier,
                                maxLength,
                                labelIds
                            });
                            return id;
                        }
                    });
            });

            return Promise.all(promises)
                .then((ids) => {
                    const id = ids.find(id => !!id);

                    // TODO: files
                    if (selectedText.length > 0 && files.length === 1) {
                        return window
                            .postMessage('useString', [{
                                id,
                                text,
                                identifier,
                                selectedText: selectedText[0]
                            }])
                            .then(() => {
                                if (sendScreenshots) {
                                    return window.postMessage('uploadScreenshots', [id], true);
                                }
                            });
                    }
                })
                .then(() => {
                    cancelEditString();
                    return search();
                })
                .finally(hideLoading);
        }
    }

    function markAsUsed(stringId) {
        const row = $(`p[int-id=${stringId}]`);
        if (row.length === 1) {
            const e = $(row[0]);
            e.bind('contextmenu', () => {
                deselectString(row[0]);
                return false;
            });
            $(e.prevAll('svg[checkicon]')[0]).attr('opacity', '1.0');
        }
    }

    function markAsUnused(stringId) {
        const row = $(`p[int-id=${stringId}]`);
        if (row.length === 1) {
            const e = $(row[0]);
            e.unbind('contextmenu');
            $(e.prevAll('svg[checkicon]')[0]).attr('opacity', '0.0');
        }
    }
    // <!--</editor-fold>-->

    // <!--<editor-fold desc="Data loading functions">-->
    function getOverrideTranslations() {
        return window.postMessage('getOverrideTranslations')
            .then(msg => $('#overrideTranslations').prop('checked', !!msg[0].overrideTranslations));
    }

    function getContentSegmentation() {
        return window.postMessage('getContentSegmentation')
            .then(msg => $('#contentSegmentation').prop('checked', !!msg[0].contentSegmentation));
    }

    function getKeyNamingOptions() {
        return window.postMessage('getKeyPatternOptions')
            .then(info => {
                const options = info[0];
                const html = options.map(o => {
                    if (o.selected) {
                        if(o.name === CUSTOM_KEY_NAMING_PATTERN){
                            $('#customKeyNamingPattern').attr('disabled', false);
                        }
                        return `<option value="${o.id}" selected>${o.name}</option>`;
                    } else {
                        return `<option value="${o.id}">${o.name}</option>`;
                    }
                }).join('');
                $('#stringsKeyNaming').find('option').remove().end().append(html);
            });
    }

    function getCustomKeyPatternValue() {
        return window.postMessage('getCustomKeyPattern')
            .then(value => {
                $('#customKeyNamingPattern').val(value)
            });
    }

    function getSourceLanguage() {
        if (!sourceLanguage) {
            return window.postMessage('getSourceLanguage')
                .then(info => {
                    sourceLanguage = info[0].sourceLanguage;
                });
        } else {
            return new Promise((res, rej) => {
                res();
            });
        }
    }

    function getProjects() {
        return window.postMessage('getProjects')
            .then(info => {
                projectsInfo = info[0];
                const options = projectsInfo.projects.map(pr => {
                    if (pr.id === projectsInfo.selectedProjectId) {
                        return `<option value="${pr.id}" selected></option>`;
                    } else {
                        return `<option value="${pr.id}"></option>`;
                    }
                }).join('');
                $('#projects').find('option').remove().end().append(options);
                projectsInfo.projects.forEach(pr => {
                    //adding text here via "text" method to avoid issues with strings which contain html tags
                    $('#projects').find(`option[value=${pr.id}]`).text(pr.name);
                });
            });
    }

    function getLanguages() {
        if (!languages) {
            return window.postMessage('getLanguages')
                .then(res => {
                    languages = res[0];
                    const allLangOption = `<option value="-1">${allLanguagesOption || ''}</option>`;
                    const sourceLangOption = `<option value="${sourceLanguage ? sourceLanguage.id : -1}"></option>`;
                    const optionsForDuplicateMode = allLangOption + languages.map(lan => {
                        return `<option value="${lan.id}"></option>`;
                    }).join('');
                    const optionsForCurrentMode = sourceLangOption + languages.map(lan => {
                        return `<option value="${lan.id}"></option>`;
                    }).join('');
                    $('#languages').find('option').remove().end().append(optionsForDuplicateMode);
                    $('#languages-preview-duplicate').find('option').remove().end().append(optionsForDuplicateMode);
                    $('#languages-preview-current').find('option').remove().end().append(optionsForCurrentMode);
                    languages.forEach(lan => {
                        //adding text here via "text" method to avoid issues with strings which contain html tags
                        $('#languages').find(`option[value=${lan.id}]`).text(lan.name);
                        $('#languages-preview-duplicate').find(`option[value=${lan.id}]`).text(lan.name);
                        $('#languages-preview-current').find(`option[value=${lan.id}]`).text(lan.name);
                    });
                    if (sourceLanguage) {
                        $('#languages-preview-current').find(`option[value=${sourceLanguage.id}]`).text(sourceLanguage.name);
                    }
                });
        } else {
            return new Promise((res, rej) => {
                res();
            });
        }
    }

    function getFiles() {
        if (isStringsBased() || files) {
          return new Promise((res, rej) => {
            res();
          });
        }

        return window.postMessage('getFiles')
            .then(res => {
                files = res[0];
                const supportedFiles = files.filter(file => editableFileTypes.includes(file.type));
                if(!supportedFiles.length) {
                    $('#string-files').replaceWith(`
                        <p>
                            ${validationMessages.addStringEmptyFile} <a crowdin-ui-text-label="contactUsTab" href="#" onclick="textFormatsClick()">selected formats</a> only
                        </p>
                    `)
                    return
                }
                const options = supportedFiles
                    .map(file => {
                        return `<option value="${file.id}"></option>`;
                    }).join('');
                $('#string-files').find('option').remove().end().append(options);
                supportedFiles.forEach(file => {
                    //adding text here via "text" method to avoid issues with strings which contain html tags
                    $('#string-files').find(`option[value=${file.id}]`).text(file.name);
                });
                $('#string-files').selectpicker('refresh');
            });
    }

    function getLabels() {
        if (!labels) {
            return window.postMessage('getLabels')
                .then(res => {
                    labels = res[0];
                    const options = labels
                        .map(label => {
                            return `<option value="${label.id}"></option>`;
                        }).join('');
                    $('#string-labels').find('option').remove().end().append(options);
                    labels.forEach(label => {
                        //adding text here via "text" method to avoid issues with strings which contain html tags
                        $('#string-labels').find(`option[value=${label.id}]`).text(label.title);
                    });
                    $('#string-labels').selectpicker('refresh');
                });
        } else {
            return new Promise((res, rej) => {
                res();
            });
        }
    }

    function getStrings() {
        if (!strings) {
            return window.postMessage('getStrings')
                .then(res => {
                    strings = res[0];
                    return search();
                });
        } else {
            return new Promise((res, rej) => {
                res();
            });
        }
    }

    function getBranches() {
        return window.postMessage('getBranches')
            .then(res => {
                let resp = res[0];
                selectedBranch = resp.selectedBranchId;
                let options = `<option value="-1" ${selectedBranch < 0 ? 'selected' : ''}>${noBranchOption || ''}</option>`;
                options += resp.branches
                    .map(br => {
                        return `<option value="${br.id}" ${br.id === selectedBranch ? 'selected' : ''}></option>`;
                    }).join('');
                $('#branches').find('option').remove().end().append(options);
                resp.branches.forEach(br => {
                    //adding text here via "text" method to avoid issues with strings which contain html tags
                    $('#branches').find(`option[value=${br.id}]`).text(br.name);
                });
            });
    }
    // <!--</editor-fold>-->

    let searchTimer;
    function debounceSearch() {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(search, 700);
    }

    function search() {
        const editIcon = `
            <svg class="float-right string-row-edit string-row-icon" onclick="openEditString(this);" width="16px" height="16px" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M11.293 1.293a1 1 0 0 1 1.414 0l2 2a1 1 0 0 1 0 1.414l-9 9a1 1 0 0 1-.39.242l-3 1a1 1 0 0 1-1.266-1.265l1-3a1 1 0 0 1 .242-.391l9-9zM12 2l2 2-9 9-3 1 1-3 9-9z"/>
                <path fill-rule="evenodd" d="M12.146 6.354l-2.5-2.5.708-.708 2.5 2.5-.707.708zM3 10v.5a.5.5 0 0 0 .5.5H4v.5a.5.5 0 0 0 .5.5H5v.5a.5.5 0 0 0 .5.5H6v-1.5a.5.5 0 0 0-.5-.5H5v-.5a.5.5 0 0 0-.5-.5H3z"/>
            </svg>
        `;

        const checkIcon = `
            <svg checkicon class="float-left string-row-icon" width="16px" height="16px" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M10.97 4.97a.75.75 0 0 1 1.071 1.05l-3.992 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.236.236 0 0 1 .02-.022z"/>
            </svg>
        `;

        const checkIconBlank = `
            <svg checkicon class="float-left string-row-icon" width="16px" height="16px" viewBox="0 0 16 16" fill="currentColor" opacity="0.0" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M10.97 4.97a.75.75 0 0 1 1.071 1.05l-3.992 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.236.236 0 0 1 .02-.022z"/>
            </svg>
        `;

        const infoIconTemplate = `
            <svg id="%str-info-icon-identifier%" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="float-right string-row-info string-row-icon" fill="currentColor">
                <title></title>
                <path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path>
            </svg>
        `;

        let text = $('#search-text').val();
        if (text) {
            text = text.trim().toLowerCase();
        }
        const arr = strings || [];
        const filteredStrings = (!text || text.length === 0)
            ? arr
            : arr.filter(str =>
                str.text.toLowerCase().includes(text) ||
                (str.identifier && str.identifier.toLowerCase().includes(text)) ||
                (str.context && str.context.toLowerCase().includes(text)) ||
                (str.labelIds && str.labelIds.length > 0 && labels.filter(l => str.labelIds.includes(l.id)).some(l => l.title.toLowerCase().includes(text)))
            );
        const limited = filteredStrings.length > 1000 ? filteredStrings.slice(0, 1000) : filteredStrings;

        return window.postMessage('getUsedStrings')
            .then((e) => {
                const usedStrings = e[0];
                const texts = limited.map(str => {
                    const isUsed = usedStrings.includes(str.id);
                    const file = files && files.find(f => f.id === str.fileId);
                    const editable = file && editableFileTypes.includes(file.type) || isStringsBased();
                    const infoIcon = infoIconTemplate.replace('%str-info-icon-identifier%', `str-info-icon-${str.id}`);

                    return `
                        ${isUsed ? checkIcon : checkIconBlank}${infoIcon}${editable ? editIcon : ''}
                        <p
                            class="string-row"
                            onclick="useString(this)"
                            ${isUsed ? 'oncontextmenu="deselectString(this);return false;"' : ''}
                            int-id="${str.id}"
                            ${!!str.identifier ? `str-id="${str.identifier}"` : ''}
                        >
                        </p>
                    `;
                });
                $('#strings-container').find('p, svg').remove().end().append(texts);

                limited.forEach(str => {
                    //adding text here via "text" method to avoid issues with strings which contain html tags
                    let infoText = `Identifier:\n${str.identifier ? str.identifier : str.text}\n\nContext:\n${str.context}`;
                    const file = files && files.find(f => f.id === str.fileId);

                    if (file) {
                        infoText += `\n\nFile:\n${file.name}`;
                    }

                    if (str.labelIds && str.labelIds.length > 0) {
                        infoText += `\n\nLabels:\n${labels.filter(l => str.labelIds.includes(l.id)).map(l => l.title).join(',')}`;
                    }

                    $('#strings-container').find(`p[int-id=${str.id}]`).text(str.text);
                    $('#strings-container').find(`svg[id=str-info-icon-${str.id}`).find('title').text(infoText);
                });
            });
    }

    //texts
    function loadText() {
        window.postMessage('getTexts').then(e => {
            const uiTexts = e[0].ui;
            validationMessages = uiTexts.validation;
            allLanguagesOption = uiTexts.labels.allLanguagesOption;
            noBranchOption = uiTexts.labels.noBranchOption;
            const labels = $('[crowdin-ui-text-label]');
            for (let i = 0; i < labels.length; i++) {
                const label = $(labels[i]);
                const key = label.attr('crowdin-ui-text-label');
                label.text(uiTexts.labels[key] || '');
            }
            const detailsArr = $('[crowdin-ui-text-details]');
            for (let i = 0; i < detailsArr.length; i++) {
                const details = $(detailsArr[i]);
                const key = details.attr('crowdin-ui-text-details');
                details.attr('title', (uiTexts.details[key] || ''));
            }
            applyCustomText(uiTexts.custom);
        });
    }

    function applyCustomText(texts) {
        $('#string-files').attr('title', texts.stringFilesSelectPlaceholder);
        $('#string-labels').attr('title', texts.stringLabelsSelectPlaceholder);
    }

    loadText();
</script>

</html>